<html>
<head>
<script>
window.onerror = function(message, url, lineNumber) {  
console.log(''); 
return true; // prevents browser error messages  
};	
/*
	

*/

function loadJSON(callback) {
	var xobj = new XMLHttpRequest();
	xobj.overrideMimeType("application/json");
	xobj.open('GET', 'controle_ECA.json', true); // Replace 'my_data' with the path to your file
	xobj.onreadystatechange = function () {
		if (xobj.readyState == 4 && xobj.status == "200") {
			// Required use of an anonymous callback as .open will 
			// NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
		}
	};
	xobj.send(null);  
}

function getHoras(disciplina){
	for (n = 0; n < actual_JSON2.length; n++) {
		if (actual_JSON2[n].codigo == disciplina){
			return actual_JSON2[n].horas;
		}
	}
	return 0;
}

function getNome(disciplina){
	var auxdisciplina = [];
	auxdisciplina.length = 0;
	//console.log(disciplina);
	for (w = 0; w < disciplina.length; w++) {
		for (n = 0; n < actual_JSON2.length; n++){
			if (actual_JSON2[n].codigo == disciplina[w]){
				 auxdisciplina.push(actual_JSON2[n].nome);
			}
		}	
	}
	return auxdisciplina;
}



function ativa(clickButton){
	
	// Mudar o botão clicado para o estado de materia feita
	// Veriricar se já não foi clicado antes o botão
	var posicao = disciplinasConcluidas.indexOf(clickButton.id);
	//var posicao2 = disciplinasLiberadas.indexOf(clickButton.id);
	if (posicao == -1 & (document.getElementById(clickButton.id).style.background == 'yellow')){
		// Se não existir
		//clickButton.style.background = "green";
		disciplinasConcluidas.push(clickButton.id);
		horasAulaCumpridas = horasAulaCumpridas + getHoras(clickButton.id);
	} else {
		// Se existir, desliga
		if(posicao != -1) {
			disciplinasConcluidas.splice(posicao, 1);
			horasAulaCumpridas = horasAulaCumpridas - getHoras(clickButton.id);
		}
	}

	
	// Liberar as materias que podem ser realizadas
	for (i = 0; i < actual_JSON2.length; i++) {
		var qtdpre = actual_JSON2[i].pre.length;
		var auxpre = qtdpre;
		for (j = 0; j < qtdpre; j++){
			for (k = 0; k < disciplinasConcluidas.length; k++) {
				if (actual_JSON2[i].pre[j] == disciplinasConcluidas[k]){
	    			auxpre--;
				} else if (Number(actual_JSON2[i].pre[j]) <= horasAulaCumpridas){
					// se não encontrar é porque é pre requisito de carga horaria
					auxpre--;
				}
			}
		}
		if (auxpre <= 0){
			// Concluiu todos os pre requisitos
			//document.getElementById(actual_JSON2[i].codigo).disabled = false;
			document.getElementById(actual_JSON2[i].codigo).style.background = "yellow";
			document.getElementById(actual_JSON2[i].codigo).style.color = "black";

			
			for (l = 0; l < disciplinasConcluidas.length; l++) {
				document.getElementById(disciplinasConcluidas[l]).style.background = "green";
				document.getElementById(disciplinasConcluidas[l]).style.color = "white";
			}
		} else {
			document.getElementById(actual_JSON2[i].codigo).style.background = "white";
			document.getElementById(actual_JSON2[i].codigo).style.color = "gray";
			if(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo) != -1) {
				disciplinasConcluidas.splice(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo), 1);
				horasAulaCumpridas = horasAulaCumpridas - getHoras(clickButton.id);
			}
		}
	}
	mostrarProximas(clickButton); //chama a funcao pra quando clicar em botao apagado e nao mexer o mouse;
	return 0;
}

function checkfase(){
	
}

function mostrarDisciplinas(){
	var aux = '';
	for (j = 1; j <= 11; j++){
		if (j!=11){
			aux = aux + '<input type="checkbox" id="chkBike" value="on">'+j+' Fase&nbsp;&nbsp;';
			}
		else{
			aux = aux + 'Optativas<br><br>';
		}
		for (i = 0; i < actual_JSON2.length; i++) {
			if (actual_JSON2[i].fase == j){
				aux = aux + '<button name="'+actual_JSON2[i].nome+'" id="'+actual_JSON2[i].codigo+'" onclick="ativa(this);" onmouseover="mostrarProximas(this);" onmouseup="volta(this);" onmouseout="volta(this);" ondblclick="pinta(prereq);" >'+actual_JSON2[i].nome+'</button>';
			}
		}
		aux = aux + '<br><br>';
	}
	return aux;
}

function mostrarProximas(mouseinButton){
	prereq.push(mouseinButton.id);
	for (i = 0; i < actual_JSON2.length; i++){
		var qtdpre = actual_JSON2[i].pre.length;
		var auxpre = qtdpre;	
		if (mouseinButton.id == actual_JSON2[i].codigo){
			if(qtdpre !=0){
				for (j = 0; j < qtdpre; j++){
					if(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo) == -1){
						if(prereq.indexOf(actual_JSON2[i].pre[j]) == -1){
							if (isFinite(actual_JSON2[i].pre[j])){
								}
								else {
								prereq.push(actual_JSON2[i].pre[j]);
							}
						}
					}
					else {
						prereq.splice(prereq.indexOf(actual_JSON2[i].codigo),1)};
				}
				mostrarProximas3(prereq);
				return;
			}			
		}	
	}
	//console.log(prereq);
	return;
}

function mostrarProximas3(prereq){
	for (v = 1; v < prereq.length; v++){
		for (db = 0; db < actual_JSON2.length; db++){
			if (prereq[v] == actual_JSON2[db].codigo){
				for (db1 = 0; db1 < actual_JSON2[db].pre.length; db1++){
					if(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo) == -1){
						if(isFinite(actual_JSON2[db].pre[db1])){
							}
							else{
							prereq.push(actual_JSON2[db].pre[db1]);
						}
					}			
				}
			}
		}
	}
	pinta(prereq);
}



function pinta(prereq){
	tamprereq = prereq.length;
	for (t = 0; t < tamprereq; t++){
		if ((document.getElementById(prereq[t]).style.background) == "green"){
			document.getElementById(prereq[t]).style.color = "white";
		} else if((document.getElementById(prereq[t]).style.background) == "yellow"){
			document.getElementById(prereq[t]).style.background = "darkred";
			document.getElementById(prereq[t]).style.color = "white";
		} else if (document.getElementById(prereq[t]).style.background == "white"){
			document.getElementById(prereq[t]).style.background = "darkred";
			document.getElementById(prereq[t]).style.color = "white";
		}
	}
}


function volta(mouseoutButton){
	prereq.length = 0;
	ativa(document.getElementById('a1'));
}


//------------

var disciplinasConcluidas = [];
var disciplinasLiberadas = [];
var prereq = [];
//var prereqprint = [];
var prereqaux = [];
//actual_JSON2 contem todas as disciplinas
var actual_JSON2;
var horasAulaCumpridas = 0;

loadJSON(function(response) {
	// Parse JSON string into object
	var actual_JSON = JSON.parse(response);
	actual_JSON2 = actual_JSON;
	document.write(mostrarDisciplinas());
	document.write('<div style="visibility: hidden" hidden=""><button id="a1" disabled=""></button></div>');
	ativa(document.getElementById('a1'));
});

</script>
<title>Controle Curricular</title>
</head>
<body>
	
</body>
</html>
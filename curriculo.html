<html>
<head>
<script>
	
/*
	

*/

function loadJSON(callback) {
	var xobj = new XMLHttpRequest();
	xobj.overrideMimeType("application/json");
	xobj.open('GET', 'controle_ECA.json', true); // Replace 'my_data' with the path to your file
	xobj.onreadystatechange = function () {
		if (xobj.readyState == 4 && xobj.status == "200") {
			// Required use of an anonymous callback as .open will 
			// NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
		}
	};
	xobj.send(null);  
}

function getHoras(disciplina){
	for (n = 0; n < actual_JSON2.length; n++) {
		if (actual_JSON2[n].codigo == disciplina){
			return actual_JSON2[n].horas;
		}
	}
	return 0;
}

function getNome(disciplina){
	for (n = 0; i < actual_JSON2.length; n++) {
		for (w = 0; w < disciplina.length; w++){
			if (actual_JSON2[n].codigo == disciplina[w]){
				return actual_JSON2[n].nome;
			}
		}	
	}
	return 0;
}

function ativa(clickButton){
	
	// Mudar o botão clicado para o estado de materia feita
	// Veriricar se já não foi clicado antes o botão
	var posicao = disciplinasConcluidas.indexOf(clickButton.id);
	if (posicao == -1){
		// Se não existir
		clickButton.style.background = "green";
		disciplinasConcluidas.push(clickButton.id);
		horasAulaCumpridas = horasAulaCumpridas + getHoras(clickButton.id);
	} else {
		// Se existir, desliga
		if(posicao != -1) {
			disciplinasConcluidas.splice(posicao, 1);
			horasAulaCumpridas = horasAulaCumpridas - getHoras(clickButton.id);
		}
	}
	
	// Liberar as materias que podem ser realizadas
	for (i = 0; i < actual_JSON2.length; i++) {
		var qtdpre = actual_JSON2[i].pre.length;
		var auxpre = qtdpre;
		for (j = 0; j < qtdpre; j++){
			for (k = 0; k < disciplinasConcluidas.length; k++) {
				if (actual_JSON2[i].pre[j] == disciplinasConcluidas[k]){
	    			auxpre--;
				} else if (Number(actual_JSON2[i].pre[j]) <= horasAulaCumpridas){
					// se não encontrar é porque é pre requisito de carga horaria
					auxpre--;
				}
			}
		}
		if (auxpre <= 0){
			// Concluiu todos os pre requisitos
			//document.getElementById(actual_JSON2[i].codigo).disabled = false;
			document.getElementById(actual_JSON2[i].codigo).style.background = "yellow";
			document.getElementById(actual_JSON2[i].codigo).style.color = "black";
			for (l = 0; l < disciplinasConcluidas.length; l++) {
				document.getElementById(disciplinasConcluidas[l]).style.background = "green";
				document.getElementById(disciplinasConcluidas[l]).style.color = "black";
			}
		} else {
			document.getElementById(actual_JSON2[i].codigo).style.background = "white";
			document.getElementById(actual_JSON2[i].codigo).style.color = "gray";
			if(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo) != -1) {
				disciplinasConcluidas.splice(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo), 1);
				horasAulaCumpridas = horasAulaCumpridas - getHoras(clickButton.id);
			}
		}
	}
	mostrarProximas(clickButton);
	return 0;
}

function mostrarDisciplinas(){
	var aux = '';
	for (i = 0; i < actual_JSON2.length; i++) {
		aux = aux + '<button name="'+actual_JSON2[i].nome+'" id="'+actual_JSON2[i].codigo+'" onclick="ativa(this);" onmouseover="mostrarProximas(this);" onmouseup="volta(this);" onmouseout="volta(this);" ondblclick="pinta(prereq);" >'+actual_JSON2[i].nome+'</button><br>';
		
	}
	return aux;
}

function mostrarProximas(mouseinButton){
	//var prereq = [];
	for (i = 0; i < actual_JSON2.length; i++){
		var qtdpre = actual_JSON2[i].pre.length;
		var auxpre = qtdpre;	
		if (mouseinButton.id == actual_JSON2[i].codigo){
			if(qtdpre !=0){
				for (j = 0; j < qtdpre; j++){
					if(disciplinasConcluidas.indexOf(actual_JSON2[i].codigo) == -1){
						if(prereq.indexOf(actual_JSON2[i].pre[j]) == -1){
							//if (!isNaN(actual_JSON2[i].pre[j])){
								prereq.push(actual_JSON2[i].pre[j]);
							//}		
						}
					}
				}
				mostrarProximas3(prereq);
				return;
			}			
		}	
	}
	//console.log(prereq);
	return;
}

function mostrarProximas2(prereq){
	//console.log('MP:'+prereq);	
	for (l = 0; l < prereq.length; l++){
		//if (prereq.indexOf(actual_JSON2[i].codigo) == -1){
		for (i = 0; i < actual_JSON2.length; i++){
			if(prereq[l] != actual_JSON2[i].codigo){
				
			}	
			//}
			else{
				var qtdpre2 = actual_JSON2[i].pre.length;
				if (qtdpre2 == 0){
					
				}
				else{
					for (j = 0; j < qtdpre2; j++){
						if(prereq.indexOf(actual_JSON2[i].pre[j]) == -1){
							//if (!isNaN(actual_JSON2[i].pre[j])){
								prereq.push(actual_JSON2[i].pre[j]);	
							//}
						}
						else{//return
							}				
					}
					//mostrarProximas2(prereq);
				}
				//console.log(prereq);			
			}	
		}		
	}
	mostrarProximas2(prereq);
}

//ideia: varre vetor de prereq, depois varre db, inclui prereqnovo no prereq até nao conseguir incluir mais, precisa ver criterio de parada.

function mostrarProximas3(prereq){

	//tamanhoprereq = prereq.length;
	for (v = 0; v < prereq.length; v++){
		for (db = 0; db < actual_JSON2.length; db++){
			if (prereq[v] == actual_JSON2[db].codigo){
				for (db1 = 0; db1 < actual_JSON2[db].pre.length; db1++){
					prereq.push(actual_JSON2[db].pre[db1]);
				}
			}
		}
	}
	//pinta(prereq);
}



function pinta(prereq){
	console.log('MP2:'+prereq);
	tamprereq = prereq.length;
	for (t = 0; t < tamprereq; t++){
		//if (!isNaN(prereq[t])){
		document.getElementById(prereq[t]).style.background = "blue";
		document.getElementById(prereq[t]).style.color = "white";
		//}
	}
}


function volta(mouseoutButton){
	prereq.length = 0;
	for (i = 0; i < actual_JSON2.length; i++){
		var qtdpre = actual_JSON2[i].pre.length;
		var auxpre = qtdpre;
		for (j = 0; j < qtdpre; j++){
			if (actual_JSON2[i].codigo == mouseoutButton.id){
				document.getElementById(actual_JSON2[i].pre[j]).style.background = "white";
				document.getElementById(actual_JSON2[i].pre[j]).style.color = "gray";
			}

		}
	
	}
	ativa(document.getElementById('a1'));
}


//------------

var disciplinasConcluidas = [];
var prereq = [];
//var prereqprint = [];
var prereqaux = [];
//actual_JSON2 contem todas as disciplinas
var actual_JSON2;
var horasAulaCumpridas = 0;

loadJSON(function(response) {
	// Parse JSON string into object
	var actual_JSON = JSON.parse(response);
	actual_JSON2 = actual_JSON;
	document.write(mostrarDisciplinas());
	document.write('<div style="visibility: hidden" hidden=""><button id="a1" disabled=""></button></div>');
	ativa(document.getElementById('a1'));
});

</script>
<title>Controle Curricular</title>
</head>
<body>
	
</body>
</html>